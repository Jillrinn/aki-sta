name: Main CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: 'Skip test jobs'
        required: false
        default: false
        type: boolean
      deploy-only:
        description: 'Deploy only (skip tests and build)'
        required: false
        default: false
        type: boolean

jobs:
  # ============================================
  # Backend Tests
  # ============================================
  backend-test:
    name: Backend Tests
    if: ${{ github.event_name != 'workflow_dispatch' || (!inputs.skip-tests && !inputs.deploy-only) }}
    uses: ./.github/workflows/test-backend.yml
    secrets: inherit

  # ============================================
  # Frontend Tests
  # ============================================
  frontend-test:
    name: Frontend Tests
    if: ${{ github.event_name != 'workflow_dispatch' || (!inputs.skip-tests && !inputs.deploy-only) }}
    uses: ./.github/workflows/test-frontend.yml
    secrets: inherit

  # ============================================
  # Scraper Tests
  # ============================================
  scraper-test:
    name: Scraper Tests
    if: ${{ github.event_name != 'workflow_dispatch' || (!inputs.skip-tests && !inputs.deploy-only) }}
    uses: ./.github/workflows/test-scraper.yml
    secrets: inherit

  # ============================================
  # Build
  # ============================================
  build:
    name: Build Application
    needs: [backend-test, frontend-test]
    # ビルドはテストが成功またはスキップされた場合のみ実行
    if: |
      !cancelled() && 
      (github.event_name != 'workflow_dispatch' || !inputs.deploy-only) && 
      (needs.backend-test.result == 'success' || needs.backend-test.result == 'skipped') &&
      (needs.frontend-test.result == 'success' || needs.frontend-test.result == 'skipped')
    uses: ./.github/workflows/build.yml

  # ============================================
  # E2E Tests
  # ============================================
  e2e-test:
    name: E2E Tests
    needs: [backend-test, frontend-test]
    if: |
      !cancelled() && 
      (github.event_name != 'workflow_dispatch' || (!inputs.skip-tests && !inputs.deploy-only)) && 
      (needs.backend-test.result == 'success' || needs.backend-test.result == 'skipped') &&
      (needs.frontend-test.result == 'success' || needs.frontend-test.result == 'skipped')
    uses: ./.github/workflows/test-e2e.yml
    secrets: inherit

  # ============================================
  # Deploy Azure Functions
  # ============================================
  deploy-functions:
    name: Deploy Azure Functions
    needs: [build, e2e-test, scraper-test]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      needs.build.result == 'success' &&
      needs.e2e-test.result == 'success' &&
      needs.scraper-test.result == 'success'
    uses: ./.github/workflows/deploy-azure-functions.yml
    with:
      environment: production
    secrets: inherit

  # ============================================
  # Deploy Static Web App
  # ============================================
  deploy-static-web-app:
    name: Deploy Static Web App
    needs: [build, deploy-functions]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      needs.build.result == 'success' &&
      needs.deploy-functions.result == 'success'
    uses: ./.github/workflows/deploy-static-web-app.yml
    with:
      environment: production
      build-artifact: ${{ needs.build.outputs.frontend-build-artifact }}
    secrets:
      AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROUD_GLACIER_046B3F300 }}

  # ============================================
  # Deploy Production (Legacy - Scraper など)
  # ============================================
  # deploy-production-legacy:
  #   name: Deploy Production (Legacy)
  #   needs: [deploy-functions, deploy-static-web-app]
  #   if: |
  #     github.event_name == 'push' && 
  #     github.ref == 'refs/heads/main' &&
  #     needs.deploy-functions.result == 'success' &&
  #     needs.deploy-static-web-app.result == 'success'
  #   uses: ./.github/workflows/deploy-production.yml
  #   with:
  #     environment: production
  #   secrets: inherit

  # ============================================
  # Summary
  # ============================================
  ci-summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [backend-test, frontend-test, scraper-test, build, e2e-test, deploy-functions, deploy-static-web-app]
    
    steps:
    - name: Generate Summary
      run: |
        echo "# 📊 CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Tests | ${{ needs.backend-test.result == 'success' && '✅ Passed' || needs.backend-test.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Tests | ${{ needs.frontend-test.result == 'success' && '✅ Passed' || needs.frontend-test.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Scraper Tests | ${{ needs.scraper-test.result == 'success' && '✅ Passed' || needs.scraper-test.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result == 'success' && '✅ Passed' || needs.build.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E Tests | ${{ needs.e2e-test.result == 'success' && '✅ Passed' || needs.e2e-test.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy Functions | ${{ needs.deploy-functions.result == 'success' && '✅ Deployed' || needs.deploy-functions.result == 'skipped' && '⏭️ Not deployed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy Static Web App | ${{ needs.deploy-static-web-app.result == 'success' && '✅ Deployed' || needs.deploy-static-web-app.result == 'skipped' && '⏭️ Not deployed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        if [ "${{ needs.backend-test.result }}" == "success" ] && \
           [ "${{ needs.frontend-test.result }}" == "success" ] && \
           [ "${{ needs.scraper-test.result }}" == "success" ] && \
           [ "${{ needs.build.result }}" == "success" ] && \
           [ "${{ needs.e2e-test.result }}" == "success" ]; then
          echo "## ✅ All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ⚠️ Some tests failed or were skipped. Please check the logs." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Generated at $(date)*" >> $GITHUB_STEP_SUMMARY
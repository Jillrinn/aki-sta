# Scraperテスト仕様書

## 概要
あんさんぶるStudioの予約状況スクレイピングシステムのテスト仕様書です。  
本ドキュメントは、`scraper/tests/`配下のテストコードの内容を日本語で記載したものです。

## テスト構成

### 1. リポジトリ層テスト (`test_cosmos_repository.py`)

#### TestCosmosWriter
Cosmos DBへのデータ保存機能をテストします。

##### テストケース

###### 1.1 正常系：データ保存成功 (`test_save_availability_success`)
- **目的**: 予約状況データが正常にCosmos DBに保存されることを確認
- **入力データ**:
  - 日付: `2025-11-15`
  - 施設情報: あんさんぶるStudio和(本郷)の3時間帯の予約状況
- **検証項目**:
  - `save_availability()`がTrueを返すこと
  - `upsert_item()`が1回呼ばれること
  - 保存されるドキュメントIDが`2025-11-15_ensemble-hongo`形式であること
  - 時間帯データが正しく保存されること

###### 1.2 異常系：Cosmos DBエラー処理 (`test_save_availability_cosmos_error`)
- **目的**: Cosmos DBでエラーが発生した場合の適切な処理を確認
- **シナリオ**: HTTP 500エラーをシミュレート
- **検証項目**:
  - エラー時にFalseが返されること
  - アプリケーションがクラッシュしないこと

###### 1.3 施設ID生成ロジック (`test_generate_facility_id`)
- **目的**: 施設名から一意のIDが正しく生成されることを確認
- **テストケース**:
  - `あんさんぶるStudio和(本郷)` → `ensemble-hongo`
  - `あんさんぶるStudio音(初台)` → `ensemble-hatsudai`
  - その他の施設名 → 小文字・ハイフン区切り形式
- **検証項目**: 各施設名が期待通りのIDに変換されること

###### 1.4 接続設定不足エラー (`test_missing_connection_settings`)
- **目的**: 環境変数が設定されていない場合のエラー処理を確認
- **検証項目**:
  - ValueErrorが発生すること
  - エラーメッセージに"Cosmos DB connection settings are missing"が含まれること

### 2. CLIエントリーポイントテスト (`test_cli.py`)

#### TestDateFormat
日付入力の柔軟性と検証機能をテストします。

##### テストケース

###### 2.1 日付形式の受け入れ (`test_date_format_with_hyphen`, `test_date_format_with_slash`)
- **目的**: 複数の日付形式が受け入れられることを確認
- **対応形式**:
  - `YYYY-MM-DD` (例: 2025-09-01)
  - `YYYY/MM/DD` (例: 2025/09/01)
- **検証項目**: 両形式でエラーなく実行できること

###### 2.2 無効な日付形式の拒否 (`test_invalid_date_format`)
- **目的**: サポートしていない日付形式が適切に拒否されることを確認
- **テストケース**: `2025.09.01`（ドット区切り）
- **検証項目**:
  - 非ゼロの終了コードが返されること
  - エラーメッセージが表示されること

###### 2.3 無効な日付値の検証 (`test_invalid_date_value`)
- **目的**: 存在しない日付（13月など）が検証されることを確認
- **テストケース**: `2025-13-01`
- **検証項目**: エラーが発生し、適切なメッセージが表示されること

###### 2.4 Cosmos DB保存時の日付正規化 (`test_normalize_date_for_cosmos_db`)
- **目的**: 異なる形式の日付が統一形式で保存されることを確認
- **シナリオ**: `2025/09/01`形式で入力
- **検証項目**:
  - Cosmos DBには`2025-09-01`形式で保存されること
  - 返却データのキーも正規化された形式になること

###### 2.5 複数日付形式の処理 (`test_multiple_date_formats`)
- **目的**: 複数の異なる形式が混在しても正しく処理されることを確認
- **検証項目**: すべての日付が`YYYY-MM-DD`形式に正規化されること

###### 2.6 過去日付バリデーション (`test_past_date_validation_logic`)
- **目的**: 過去日付の判定ロジックが正しく動作することを確認
- **テストケース**:
  - 昨日: 過去日付として判定
  - 今日: 過去日付ではない
  - 明日: 過去日付ではない
  - 無効な日付文字列: Falseを返す
- **検証項目**: 各日付が正しく分類されること

### 3. スクレイパー本体テスト (`test_ensemble_studio.py`)

#### TestTimeSlotConversion
時間から時間帯への変換機能をテストします。

##### テストケース

###### 3.1 時間帯変換 (`test_morning_slot`, `test_afternoon_slot`, `test_evening_slot`)
- **目的**: 時刻文字列が正しい時間帯に変換されることを確認
- **変換ルール**:
  - `09:00` or `9:00` → `9-12`（午前）
  - `13:00` → `13-17`（午後）
  - `18:00` → `18-21`（夜間）
- **検証項目**: 各時刻が対応する時間帯に正しく変換されること

###### 3.2 無効な時刻の処理 (`test_invalid_time`)
- **目的**: 定義外の時刻が適切に処理されることを確認
- **テストケース**: `10:00`, `invalid`, 空文字列
- **検証項目**: すべてNoneを返すこと

#### TestJapaneseYearMonthParsing
日本語年月表記のパース機能をテストします。

##### テストケース

###### 3.3 日本語年月パース (`test_parse_valid_year_month`, `test_parse_double_digit_month`)
- **目的**: 「2025年8月」形式の文字列が正しくパースされることを確認
- **検証項目**:
  - 年、月が正しく抽出されること
  - 2桁月（12月など）も正しく処理されること
  - 日付は1日に設定されること

###### 3.4 無効な形式の処理 (`test_parse_invalid_format`)
- **目的**: 日本語年月形式以外の文字列が拒否されることを確認
- **テストケース**: `invalid`, `2025/08`
- **検証項目**: Noneが返されること

#### TestEnsembleStudioScraper
スクレイパーの主要機能をテストします。

##### テストケース

###### 3.5 日付セルの特定 (`test_find_date_cell`)
- **目的**: カレンダー内から指定日付のセルを見つける機能を確認
- **検証項目**: 指定した日付（15日など）のセルが正しく特定されること

###### 3.6 営業外日の処理 (`test_extract_time_slots_disabled`)
- **目的**: 営業していない日の処理を確認
- **シナリオ**: 「－」マークがある日
- **検証項目**: すべての時間帯が`unknown`として返されること

###### 3.7 予約状況の抽出 (`test_extract_time_slots_with_marks`)
- **目的**: 時刻マークから予約状況を正しく判定することを確認
- **判定ルール**:
  - リンクあり＋「○」→ `available`（予約可能）
  - リンクなし＋「×」→ `booked`（予約済み）
- **検証項目**: 各時間帯の状態が正しく判定されること

###### 3.8 JSON保存機能 (`test_save_to_json`)
- **目的**: スクレイピング結果がJSONファイルに正しく保存されることを確認
- **検証項目**:
  - ファイルが作成されること
  - 保存内容が入力データと一致すること
  - UTF-8エンコーディングで保存されること

###### 3.9 エラー時の例外処理 (`test_scrape_availability_error_handling`)
- **目的**: Playwright接続エラー時の処理を確認
- **検証項目**: 例外が適切に再発生すること

### 4. エラーハンドリングテスト (`test_error_handling.py`)

#### TestErrorHandling
エラー発生時の適切な処理とフォールバック動作をテストします。

##### テストケース

###### 4.1 月移動失敗時のスキップ (`test_skip_studio_when_navigate_fails`)
- **目的**: 特定スタジオで月移動に失敗した場合、そのスタジオをスキップして処理を継続することを確認
- **シナリオ**: 2つのスタジオ中、1つ目で失敗
- **検証項目**:
  - 失敗したスタジオはスキップされること
  - 成功したスタジオのデータは取得されること
  - 結果に成功したスタジオのみが含まれること

###### 4.2 日付セル未発見時のスキップ (`test_skip_studio_when_date_cell_not_found`)
- **目的**: 指定日付のセルが見つからない場合の処理を確認
- **シナリオ**: 2つのスタジオ中、1つ目で日付セルが見つからない
- **検証項目**:
  - 該当スタジオはスキップされること
  - 他のスタジオの処理は継続されること

###### 4.3 全スタジオ失敗時の処理 (`test_empty_result_when_all_studios_fail`)
- **目的**: すべてのスタジオで処理に失敗した場合の動作を確認
- **検証項目**:
  - 空のリストが返されること
  - アプリケーションがクラッシュしないこと

###### 4.4 データなし時のエラーレスポンス (`test_scrape_and_save_with_no_valid_data`)
- **目的**: 有効なデータが取得できなかった場合のエラー処理を確認
- **検証項目**:
  - status: `error`
  - error_type: `NO_DATA_FOUND`
  - 適切なエラーメッセージが含まれること

###### 4.5 不明な時間帯の保持 (`test_time_slot_unknown_preserved`)
- **目的**: 時間帯情報が取得できなかった場合の処理を確認
- **検証項目**:
  - 該当時間帯は`unknown`として保持されること
  - 他の時間帯のデータは正常に処理されること

### 5. Flask APIテスト (`test_flask_api.py`)

#### TestBasicEndpoints
基本的なエンドポイントの動作をテストします。

##### テストケース

###### 5.1 ルートエンドポイント (`test_index_endpoint`)
- **エンドポイント**: `GET /`
- **検証項目**:
  - ステータスコード200
  - サービス名、実行状態、タイムスタンプが返される

###### 5.2 ヘルスチェック (`test_health_endpoint`)
- **エンドポイント**: `GET /health`
- **検証項目**:
  - ステータスコード200
  - healthy状態が返される

###### 5.3 404エラー処理 (`test_404_error`)
- **目的**: 存在しないエンドポイントへのアクセス処理
- **検証項目**:
  - ステータスコード404
  - 適切なエラーメッセージ

#### TestScrapeEndpoint
スクレイピングAPIエンドポイントの機能をテストします。

##### テストケース

###### 5.4 クエリパラメータでの日付指定 (`test_scrape_with_query_parameter`)
- **エンドポイント**: `POST /scrape?date=2025-11-15`
- **検証項目**:
  - クエリパラメータの日付が正しく処理される
  - 成功レスポンスが返される

###### 5.5 JSONボディでの日付指定 (`test_scrape_with_json_body`)
- **エンドポイント**: `POST /scrape` + JSONボディ
- **検証項目**:
  - JSONボディの日付が正しく処理される
  - Content-Type: application/jsonが必要

###### 5.6 複数日付の処理 (`test_scrape_multiple_dates`)
- **目的**: 複数日付の一括処理機能を確認
- **検証項目**:
  - 各日付が順次処理される
  - 個別の結果が配列で返される

###### 5.7 日付なしリクエスト (`test_scrape_without_dates`)
- **目的**: 必須パラメータのバリデーション確認
- **検証項目**:
  - ステータスコード400
  - エラーメッセージ「At least one date is required」

###### 5.8 過去日付のバリデーション (`test_scrape_with_past_date`)
- **目的**: 過去日付の拒否処理を確認
- **検証項目**:
  - ステータスコード400
  - エラーメッセージ「過去の日付は指定できません」

###### 5.9 無効な日付形式 (`test_scrape_with_invalid_date_format`)
- **目的**: 日付形式バリデーションを確認
- **テストケース**: `2025.11.15`（ドット区切り）
- **検証項目**:
  - ステータスコード400
  - 「Invalid date format」エラー

###### 5.10 スラッシュ形式の拒否 (`test_scrape_with_slash_date_format_rejected`)
- **目的**: API仕様（YYYY-MM-DD形式のみ）の確認
- **テストケース**: `2025/11/15`
- **検証項目**:
  - ステータスコード400
  - 「Use YYYY-MM-DD」メッセージ

#### TestErrorHandling
Flask APIのエラーハンドリングをテストします。

##### テストケース

###### 5.11 スクレイパーエラー処理 (`test_scraper_error_handling`)
- **シナリオ**: スクレイパーがエラーを返す
- **検証項目**:
  - ステータスコード500（全失敗時）
  - error_typeが正しく伝達される

###### 5.12 Playwrightエラー処理 (`test_playwright_error_handling`)
- **シナリオ**: ブラウザ未インストール
- **検証項目**:
  - error_type: BROWSER_NOT_INSTALLED
  - インストール手順を含むメッセージ

###### 5.13 ネットワークエラー処理 (`test_network_error_handling`)
- **シナリオ**: ConnectionError発生
- **検証項目**:
  - error_type: NETWORK_ERROR
  - 適切なエラーメッセージ

###### 5.14 一般的な例外処理 (`test_generic_exception_handling`)
- **シナリオ**: 予期しない例外
- **検証項目**:
  - error_type: SCRAPING_ERROR
  - 例外クラス名が含まれる

###### 5.15 部分的成功 (`test_partial_success`)
- **シナリオ**: 複数日付で一部のみ成功
- **検証項目**:
  - ステータスコード200
  - status: partial
  - 成功・失敗の内訳が正確

#### TestRequestFormats
リクエストフォーマットの処理をテストします。

##### テストケース

###### 5.16 triggeredByパラメータ (`test_triggered_by_parameter`)
- **目的**: トリガー元の記録機能を確認
- **検証項目**:
  - クエリパラメータまたはJSONボディで指定可能
  - デフォルト値: manual

###### 5.17 パラメータ優先順位 (`test_query_params_precedence`)
- **目的**: クエリパラメータの優先処理を確認
- **検証項目**:
  - クエリパラメータがJSONボディより優先される

#### TestDebugMode
デバッグモードの動作をテストします。

##### テストケース

###### 5.18 デバッグモードのトレースバック (`test_debug_mode_traceback`)
- **環境変数**: DEBUG=true
- **検証項目**:
  - エラー時にトレースバックが含まれる

###### 5.19 本番モードでのトレースバック非表示 (`test_production_mode_no_traceback`)
- **環境変数**: DEBUG=false
- **検証項目**:
  - トレースバックは含まれない
  - エラーメッセージのみ表示

## テストカバレッジ

### カバー範囲
- **リポジトリ層**: Cosmos DB操作、エラーハンドリング、ID生成
- **CLI層**: 日付入力検証、形式変換、コマンドライン処理
- **スクレイパー層**: DOM操作、データ抽出、時間帯変換
- **エラー処理**: 各層での異常系処理、フォールバック動作
- **Flask API層**: HTTPエンドポイント、リクエスト処理、レスポンス形式

### 未カバー領域
- 実際のWebサイトとの統合テスト（E2Eテストで別途カバー）
- ネットワーク遅延やタイムアウトのシミュレーション
- 並行処理時の競合状態

## テスト実行方法

```bash
# すべてのテストを実行
cd scraper && python -m pytest tests/ -v

# 特定のテストファイルを実行
python -m pytest tests/repositories/test_cosmos_repository.py -v

# カバレッジレポート付きで実行
python -m pytest tests/ --cov=src --cov-report=html
```

## 品質基準
- すべてのテストが成功すること
- コードカバレッジ80%以上
- エラーハンドリングが適切に実装されていること
- 各機能が独立してテスト可能であること